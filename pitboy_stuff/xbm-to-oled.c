/************************************************
top_bits[] ist ein xbm file (nicht x10 format)
************************************************/
#include <stdio.h>
#include <stdlib.h>

#define SHORT_LENGTH 8
#define BYTE_LENGTH 8

// Name of defined image
#define NAME top_bits

// Filename to write to
#define FILENAME "screenmemory.bin"

// Invert image
#define INVERT 0

#define top_width 80
#define top_height 48
static unsigned char top_bits[] = {
   0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0xf0, 0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf9, 0xe0,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x0d, 0x80, 0x01, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x07, 0x00, 0x03, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x60, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60,
   0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x18, 0x08,
   0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x08, 0x18, 0x18, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x10, 0x18, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x60, 0x04, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x60, 0x4c, 0x0c, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20,
   0x64, 0x0c, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x30, 0x04,
   0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x10, 0x00, 0x0c, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x10, 0x00, 0x06, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x30, 0x20, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x30, 0x03, 0x04, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30,
   0xff, 0x07, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x06, 0x0e,
   0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x88, 0xc0, 0x03, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x30, 0xe0, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0xc0, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00,
   0x00, 0x80, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x03, 0x70, 0x00, 0x00, 0xe0,
   0x00, 0x80, 0x07, 0x00, 0x80, 0x07, 0xd0, 0x00, 0x00, 0x3f, 0x00, 0x00,
   0x7c, 0x00, 0xc0, 0x06, 0xb0, 0x1f, 0xfc, 0x01, 0x00, 0x00, 0xc0, 0x07,
   0x7e, 0x03, 0x70, 0xf0, 0x07, 0x00, 0x00, 0x00, 0x00, 0xfe, 0x9f, 0xff,
   0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf1, 0x07, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x02, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x7c, 0x82, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x60, 0xfc, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0x1f,
   0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x3e, 0x00, 0xe0,
   0x03, 0x06, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x00, 0x00, 0x00, 0xff, 0x0f,
   0x00, 0x00, 0xfc, 0xff, 0x01, 0x00, 0x00, 0x00, 0x70, 0x08, 0x00, 0x00,
   0xfe, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x06, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x10, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10,
   0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,
   0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x03, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00 };




void printDisplay(unsigned char * display) {
	int i,j;
	int c=0;
	for( i=0; i<top_height; i++){
		for( j=0; j<top_width; j++){
			if(c%8 == 0) printf("B");
			if (display[i*top_width+j] != 0) {
				printf("1");
			}else{
				printf("0");
			}
			if(c%8 == 7) printf(",");
			c++;
		}
		printf("\n");
	}
	printf("\n");
}

int write_to_file(unsigned char * display, char * filename) {
	FILE * fp;
	fp = fopen(filename, "w");
	if (fp == NULL)
		return -1;

	int i, j, k;
	unsigned char tmp;
	for (i=0; i<top_height; i=i+BYTE_LENGTH) {
		for(j=(top_width-1); j>=0; j--) {
			tmp = 0;
			for( k=0; k<BYTE_LENGTH; k++){
				tmp = tmp+(display[(i+k)*top_width+j] << k);
			}
			fwrite(&tmp, 1, 1, fp);
		}
	}

	fclose(fp);
	return 0;
}

int print_file(char * filename) {
	FILE * fp;
	fp = fopen(filename, "r");
	if (fp == NULL)
		return -1;

	int i;
	unsigned char tmp;
	for (i=0; i<(top_height*top_width/8); i++) {
		tmp = 0;
		fread(&tmp, 1, 1, fp);
		printf("0x%X, ", tmp);
	}

	fclose(fp);
	return 0;
}

unsigned char * expandBitMap(
	unsigned char * bits,
	unsigned char * display
) {
	int i,j;
	for (i = 0; i<(top_width*top_height/SHORT_LENGTH); i++) {
		for (j=0; j<SHORT_LENGTH; j++) {
			display[i*SHORT_LENGTH + j] = (bits[i] & (1 << j)) >> j;
			if (INVERT == 1) {
				if (display[i*SHORT_LENGTH + j] == 0)
					display[i*SHORT_LENGTH + j] = 1;
				else
					display[i*SHORT_LENGTH + j] = 0;
			}
		}
	}
	return display;
}

int main() {
	unsigned char * display = malloc(top_width*top_height);
	display = expandBitMap(NAME,display);
	printDisplay(display);
	write_to_file(display, FILENAME);
	print_file(FILENAME);
	free(display);
	return 0;
}
