/************************************************
top_bits[] ist ein xbm file (nicht x10 format)
************************************************/
#include <stdio.h>
#include <stdlib.h>

#define SHORT_LENGTH 8
#define BYTE_LENGTH 8

// Name of defined image
#define NAME top_bits

// Filename to write to
#define FILENAME "screenmemory.bin"

// Invert image
#define INVERT 1

#define top_width 64
#define top_height 48
static unsigned char top_bits[] = {
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07, 0xfc, 0xff, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00,
   0x00, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x00, 0x00, 0xf0, 0xff, 0xff,
   0xff, 0xff, 0x0f, 0x00, 0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x07, 0x00,
   0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0xff, 0xff,
   0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0xfc, 0xff, 0xff, 0xff, 0x01, 0x00,
   0x00, 0x00, 0xfc, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff,
   0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0x7f, 0x00, 0xcc,
   0x01, 0x00, 0xf0, 0xff, 0xff, 0x7f, 0x00, 0x9f, 0x03, 0x00, 0xe0, 0xff,
   0xff, 0x7f, 0x00, 0x00, 0x06, 0x00, 0xe0, 0xff, 0xff, 0x3f, 0x00, 0x00,
   0x00, 0x00, 0xe0, 0xff, 0xff, 0x3f, 0x00, 0x8c, 0x01, 0x00, 0xc0, 0xff,
   0xff, 0x3f, 0x00, 0xde, 0x03, 0x00, 0xc0, 0xff, 0xff, 0x3f, 0x00, 0xd6,
   0x02, 0x00, 0xc0, 0xff, 0xff, 0x3f, 0x00, 0xde, 0x03, 0x00, 0xc0, 0xff,
   0xff, 0x3f, 0x00, 0xde, 0x03, 0x00, 0xc0, 0xff, 0xff, 0x1f, 0x00, 0x0c,
   0x00, 0x00, 0xc0, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xff,
   0xff, 0xcf, 0x01, 0x00, 0x00, 0x1c, 0xc0, 0xff, 0xff, 0x0f, 0x01, 0x00,
   0x00, 0x37, 0xc0, 0xff, 0xff, 0x0f, 0x00, 0x00, 0x80, 0x31, 0xe0, 0xff,
   0xff, 0xdf, 0x00, 0x00, 0x80, 0x30, 0xe0, 0xff, 0xff, 0x9f, 0x00, 0x00,
   0x00, 0x1b, 0xe0, 0xff, 0xff, 0xbf, 0x01, 0x00, 0x80, 0x09, 0xe0, 0xff,
   0xff, 0x3f, 0x03, 0x00, 0xc0, 0x0e, 0xf0, 0xff, 0xff, 0x7f, 0x06, 0x00,
   0x70, 0x02, 0xf0, 0xff, 0xff, 0x7f, 0x0c, 0x00, 0x1c, 0x00, 0xf0, 0xff,
   0xff, 0x7f, 0x38, 0x00, 0x0f, 0x00, 0xf8, 0xff, 0xff, 0x7f, 0xe0, 0xff,
   0x01, 0x00, 0xf8, 0xff, 0xff, 0xff, 0x00, 0x1e, 0x00, 0x00, 0xfc, 0xff,
   0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0x00, 0x00,
   0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0xff, 0xff,
   0xff, 0xff, 0x01, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 0xff, 0x03, 0x00,
   0x00, 0xc0, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x00, 0x00, 0xe0, 0xff, 0xff,
   0xff, 0xff, 0x0f, 0x00, 0x00, 0xf0, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x00,
   0x00, 0xfc, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1f, 0x00, 0xfe, 0xff, 0xff,
   0xff, 0xff, 0xff, 0x07, 0x80, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x07,
   0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x03, 0xff, 0xff, 0xff, 0xff };

void printDisplay(unsigned char * display) {
	int i,j;
	for( i=0; i<top_height; i++){
		for( j=0; j<top_width; j++){
			if (display[i*top_width+j] != 0)
				printf("X");
			else
				printf(" ");
		}
		printf("\n");
	}
	printf("\n");
}

int write_to_file(unsigned char * display, char * filename) {
	FILE * fp;
	fp = fopen(filename, "w");
	if (fp == NULL)
		return -1;

	int i, j, k;
	unsigned char tmp;
	for (i=0; i<top_height; i=i+BYTE_LENGTH) {
		for(j=(top_width-1); j>=0; j--) {
			tmp = 0;
			for( k=0; k<BYTE_LENGTH; k++){
				tmp = tmp+(display[(i+k)*top_width+j] << k);
			}
			fwrite(&tmp, 1, 1, fp);
		}
	}

	fclose(fp);
	return 0;
}

int print_file(char * filename) {
	FILE * fp;
	fp = fopen(filename, "r");
	if (fp == NULL)
		return -1;

	int i;
	unsigned char tmp;
	for (i=0; i<(top_height*top_width/8); i++) {
		tmp = 0;
		fread(&tmp, 1, 1, fp);
		printf("0x%X, ", tmp);
	}

	fclose(fp);
	return 0;
}

unsigned char * expandBitMap(
	unsigned char * bits,
	unsigned char * display
) {
	int i,j;
	for (i = 0; i<(top_width*top_height/SHORT_LENGTH); i++) {
		for (j=0; j<SHORT_LENGTH; j++) {
			display[i*SHORT_LENGTH + j] = (bits[i] & (1 << j)) >> j;
			if (INVERT == 1) {
				if (display[i*SHORT_LENGTH + j] == 0)
					display[i*SHORT_LENGTH + j] = 1;
				else
					display[i*SHORT_LENGTH + j] = 0;
			}
		}
	}
	return display;
}

int main() {
	unsigned char * display = malloc(top_width*top_height);
	display = expandBitMap(NAME,display);
	printDisplay(display);
	write_to_file(display, FILENAME);
	print_file(FILENAME);
	free(display);
	return 0;
}
